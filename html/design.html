<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Photo Book Designer - Design</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Extended -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Montserrat:wght@300;400;600;700&family=Roboto:wght@300;400;700&family=Open+Sans:wght@300;400;700&family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&family=Merriweather:wght@300;400;700&family=Raleway:wght@300;400;700&family=Oswald:wght@300;400;700&family=Dancing+Script:wght@400;700&family=Pacifico&family=Great+Vibes&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Photo Book Designer...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Hint -->
    <div id="keyboardHint" class="keyboard-hint">
        Press <kbd>?</kbd> for keyboard shortcuts
    </div>

    <!-- Design Screen -->
    <div id="designScreen" class="design-screen">
        <!-- Modern Clean Header -->
        <div class="design-header-clean">
            <button class="btn-back" onclick="window.location.href='upload.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-center">
                <h1 class="header-title">Design</h1>
            </div>
            <button class="btn-header-icon btn-export-icon" id="exportBtn" title="Export PDF">
                <i class="fas fa-download"></i>
            </button>
        </div>

        <!-- Page Info Bar -->
        <div class="page-info-bar">
            <span class="page-counter-large" id="pageCounter">Page 1 / 10</span>
            <button class="btn-add-page" onclick="PageManager.addPage()">
                <i class="fas fa-plus"></i>
                <span>Add Page</span>
            </button>
        </div>

        <!-- Main Canvas Area -->
        <div class="canvas-area-clean">
            <div id="pageCanvas" class="page-canvas landscape">
                <div id="imageContainer" class="image-grid classic"></div>
                <div id="textContainer"></div>
            </div>
        </div>

        <!-- Element Toolbar (Floating when element selected) -->
        <div id="elementToolbar" class="element-toolbar-floating">
            <button class="btn-tool" onclick="FreeLayout.bringToFront()" title="Front">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button class="btn-tool" onclick="FreeLayout.sendToBack()" title="Back">
                <i class="fas fa-arrow-down"></i>
            </button>
            <div class="tool-divider"></div>
            <input type="number" class="tool-input" id="rotationValue" placeholder="0°" min="-180" max="180" value="0">
            <div class="tool-divider"></div>
            <button class="btn-tool btn-danger" onclick="FreeLayout.deleteSelected()" title="Delete">
                <i class="fas fa-trash"></i>
            </button>
        </div>

        <!-- Bottom Controls Panel (Collapsible) -->
        <div class="bottom-controls">
            <!-- Controls Toggle Bar -->
            <div class="controls-toggle-bar">
                <button class="control-toggle-btn active" data-panel="photos">
                    <i class="fas fa-images"></i>
                </button>
                <button class="control-toggle-btn" data-panel="layout">
                    <i class="fas fa-th-large"></i>
                </button>
                <button class="control-toggle-btn" data-panel="text">
                    <i class="fas fa-font"></i>
                </button>
                <button class="control-toggle-btn" data-panel="style">
                    <i class="fas fa-palette"></i>
                </button>
                <button class="control-toggle-btn" data-panel="pages">
                    <i class="fas fa-file"></i>
                </button>
            </div>

            <!-- Panels Container -->
            <div class="controls-panels-container">
                <!-- Photos Panel -->
                <div class="control-panel active" id="panel-photos">
                    <div class="panel-header">
                        <h3>Photo Library</h3>
                        <label for="libraryUpload" class="btn-add">
                            <i class="fas fa-plus"></i>
                        </label>
                        <input type="file" id="libraryUpload" multiple accept="image/*" class="hidden">
                    </div>
                    <div class="photo-library-grid" id="photoLibraryGrid">
                        <div class="empty-state-compact">
                            <i class="fas fa-images"></i>
                            <span>No photos</span>
                        </div>
                    </div>
                </div>

                <!-- Layout Panel -->
                <div class="control-panel" id="panel-layout">
                    <div class="panel-header">
                        <h3>Layout</h3>
                    </div>
                    <div class="panel-content">
                        <div class="layout-mode-selector">
                            <input type="radio" class="mode-radio" name="layoutMode" id="layoutModeGrid" value="grid" checked>
                            <label class="mode-btn" for="layoutModeGrid">
                                <i class="fas fa-th"></i>
                                <span>Grid</span>
                            </label>
                            <input type="radio" class="mode-radio" name="layoutMode" id="layoutModeFree" value="free">
                            <label class="mode-btn" for="layoutModeFree">
                                <i class="fas fa-arrows-alt"></i>
                                <span>Free</span>
                            </label>
                        </div>

                        <div id="gridSettings" class="layout-settings">
                            <div class="setting-group">
                                <label>Template</label>
                                <select class="setting-input" id="gridTemplateSelector">
                                    <option value="1x1">1×1</option>
                                    <option value="2x2" selected>2×2</option>
                                    <option value="3x3">3×3</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <div class="setting-group">
                                    <label>Rows</label>
                                    <input type="number" class="setting-input" id="gridRows" min="1" max="6" value="2">
                                </div>
                                <div class="setting-group">
                                    <label>Columns</label>
                                    <input type="number" class="setting-input" id="gridCols" min="1" max="6" value="2">
                                </div>
                            </div>
                            <button class="btn-action" id="autoArrangeBtn">
                                <i class="fas fa-magic"></i> Auto Arrange
                            </button>
                        </div>

                        <div id="freeModeSettings" class="layout-settings" style="display: none;">
                            <p class="info-text">
                                <i class="fas fa-info-circle"></i>
                                Drag, resize & rotate freely
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Text Panel -->
                <div class="control-panel" id="panel-text">
                    <div class="panel-header">
                        <h3>Text</h3>
                        <button class="btn-add" id="addTextBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="textBlocksList" class="text-blocks-list"></div>
                    <div id="textEditor" class="text-editor" style="display: none;">
                        <textarea class="text-input" id="textContent" placeholder="Enter text..."></textarea>
                        <div class="text-controls">
                            <select class="setting-input" id="fontFamily">
                                <!-- Populated by TextEditor -->
                            </select>
                            <input type="number" class="setting-input-sm" id="fontSize" min="8" max="72" value="16" placeholder="Size">
                            <input type="color" class="color-input" id="textColor" value="#000000">
                        </div>
                    </div>
                </div>

                <!-- Style Panel -->
                <div class="control-panel" id="panel-style">
                    <div class="panel-header">
                        <h3>Page Style</h3>
                    </div>
                    <div class="panel-content">
                        <div class="setting-group">
                            <label>Background</label>
                            <input type="color" class="color-input-large" id="bgColor" value="#ffffff">
                        </div>
                        <div class="setting-group">
                            <label>Pattern</label>
                            <select class="setting-input" id="bgPattern">
                                <option value="none">None</option>
                                <option value="dots">Dots</option>
                                <option value="lines">Lines</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Pages Panel -->
                <div class="control-panel" id="panel-pages">
                    <div class="panel-header">
                        <h3>Page Actions</h3>
                    </div>
                    <div class="panel-content">
                        <button class="btn-action" onclick="PageManager.duplicatePage(currentPageIndex)">
                            <i class="fas fa-copy"></i> Duplicate
                        </button>
                        <button class="btn-action" onclick="PageManager.clearPage(currentPageIndex)">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- interact.js for drag/resize/rotate -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.17/dist/interact.min.js"></script>

    <!-- Custom Modules -->
    <script src="../js/ui-manager.js"></script>
    <script src="../js/touch-gestures.js"></script>
    <script src="../js/page-manager.js"></script>
    <script src="../js/photo-library.js"></script>
    <script src="../js/grid-layout.js"></script>
    <script src="../js/free-layout.js"></script>
    <script src="../js/text-editor.js"></script>
    <script src="../js/pdf-export.js"></script>

    <script>
        // Load book data from localStorage
        let bookData = JSON.parse(localStorage.getItem('bookData'));
        let currentPageIndex = parseInt(localStorage.getItem('currentPageIndex')) || 0;
        let selectedTextBlockIndex = null;

        // Redirect to setup if no data
        if (!bookData) {
            window.location.href = 'setup.html';
        }

        // Migrate and ensure data structure
        function migrateBookData() {
            // Ensure photoLibrary exists
            if (!bookData.photoLibrary) {
                bookData.photoLibrary = [];
            }

            // Ensure pages have required properties
            bookData.pages.forEach((page, index) => {
                if (!page.id) page.id = 'page_' + index;
                if (!page.textBlocks) page.textBlocks = [];
                if (!page.elements) page.elements = [];
                if (!page.images) page.images = [];
                if (!page.imageColumns) page.imageColumns = bookData.layout === 'classic' ? 1 : bookData.layout === 'modern' ? 2 : 3;
                if (!page.imageSpacing) page.imageSpacing = 20;
                if (!page.bgPattern) page.bgPattern = 'none';
                if (!page.layoutMode) page.layoutMode = 'grid';
                if (!page.gridTemplate) page.gridTemplate = '2x2';
                if (!page.gridRows) page.gridRows = 2;
                if (!page.gridCols) page.gridCols = 2;
                if (!page.gridSpacing) page.gridSpacing = 20;
                if (!page.gridPadding) page.gridPadding = 40;
            });

            saveBookData();
        }

        migrateBookData();

        // Initialize page
        function init() {
            // Update info elements if they exist (optional)
            const totalPagesEl = document.getElementById('totalPages');
            const currentLayoutEl = document.getElementById('currentLayout');
            const currentOrientationEl = document.getElementById('currentOrientation');
            const totalPagesIndicatorEl = document.getElementById('totalPagesIndicator');

            if (totalPagesEl) totalPagesEl.textContent = bookData.numPages;
            if (currentLayoutEl) currentLayoutEl.textContent = bookData.layout.charAt(0).toUpperCase() + bookData.layout.slice(1);
            if (currentOrientationEl) currentOrientationEl.textContent = bookData.orientation.charAt(0).toUpperCase() + bookData.orientation.slice(1);
            if (totalPagesIndicatorEl) totalPagesIndicatorEl.textContent = bookData.numPages;

            // Initialize modules
            // UIManager.init(); // Disabled - using fixed bottom nav instead of swipe bottom sheet
            TouchGestures.init();
            PageManager.init();
            PhotoLibrary.init();
            GridLayout.init();
            FreeLayout.init();
            TextEditor.init();
            PDFExport.init();

            setupEventListeners();
            renderCurrentPage();
            updateNavigationButtons();
        }

        // Setup Bottom Navigation
        function setupBottomNavigation() {
            const toggleBtns = document.querySelectorAll('.control-toggle-btn');
            const panels = document.querySelectorAll('.control-panel');

            toggleBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetPanel = this.getAttribute('data-panel');

                    // Remove active class from all buttons and panels
                    toggleBtns.forEach(b => b.classList.remove('active'));
                    panels.forEach(panel => panel.classList.remove('active'));

                    // Add active class to clicked button
                    this.classList.add('active');

                    // Show corresponding panel
                    const panel = document.getElementById('panel-' + targetPanel);
                    if (panel) {
                        panel.classList.add('active');
                    }

                    // If switching to text tab and a text block is selected, show editor
                    if (targetPanel === 'text' && selectedTextBlockIndex !== null) {
                        document.getElementById('textEditor').style.display = 'block';
                    }
                });
            });
        }

        // Helper function to switch tabs programmatically
        function switchToTab(tabName) {
            const targetButton = document.querySelector(`.control-toggle-btn[data-panel="${tabName}"]`);
            if (targetButton) {
                targetButton.click();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Bottom Navigation Tab Switching
            setupBottomNavigation();

            // Library upload
            const libraryUploadEl = document.getElementById('libraryUpload');
            if (libraryUploadEl) {
                libraryUploadEl.addEventListener('change', function(e) {
                    console.log('File input changed! Files:', e.target.files);
                    if (e.target.files && e.target.files.length > 0) {
                        console.log('Calling PhotoLibrary.uploadPhotos...');
                        PhotoLibrary.uploadPhotos(e.target.files);
                        e.target.value = '';
                    } else {
                        console.log('No files selected');
                    }
                });
            }

            // Layout mode toggle
            document.querySelectorAll('input[name="layoutMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const newMode = this.value;
                    const page = bookData.pages[currentPageIndex];
                    page.layoutMode = newMode;

                    // Toggle settings visibility
                    document.getElementById('gridSettings').style.display = newMode === 'grid' ? 'block' : 'none';
                    document.getElementById('freeModeSettings').style.display = newMode === 'free' ? 'block' : 'none';

                    // Convert images to appropriate format
                    if (newMode === 'free') {
                        page.images = page.images.map((img, i) => {
                            if (typeof img === 'string') {
                                return {
                                    src: img,
                                    x: 20 + (i % 3) * 250,
                                    y: 20 + Math.floor(i / 3) * 250,
                                    width: 220,
                                    height: 220,
                                    rotation: 0,
                                    zIndex: i + 1
                                };
                            }
                            return img;
                        });

                        // Add position/size to text blocks
                        if (page.textBlocks) {
                            page.textBlocks.forEach((block, i) => {
                                if (!block.x) block.x = 20;
                                if (!block.y) block.y = 500 + (i * 80);
                                if (!block.width) block.width = 300;
                                if (!block.rotation) block.rotation = 0;
                            });
                        }
                    }

                    saveBookData();
                    renderCurrentPage();
                    PageManager.renderThumbnailStrip();
                });
            });

            // Background controls
            const bgColorEl = document.getElementById('bgColor');
            if (bgColorEl) {
                bgColorEl.addEventListener('change', function() {
                    bookData.pages[currentPageIndex].backgroundColor = this.value;
                    const colorValueEl = document.getElementById('colorValue');
                    if (colorValueEl) colorValueEl.textContent = this.value;
                    saveBookData();
                    renderCurrentPage();
                    PageManager.renderThumbnailStrip();
                });
            }

            const bgPatternEl = document.getElementById('bgPattern');
            if (bgPatternEl) {
                bgPatternEl.addEventListener('change', function() {
                    bookData.pages[currentPageIndex].bgPattern = this.value;
                    saveBookData();
                    renderCurrentPage();
                });
            }

            // Auto arrange button
            const autoArrangeBtnEl = document.getElementById('autoArrangeBtn');
            if (autoArrangeBtnEl) {
                autoArrangeBtnEl.addEventListener('click', function() {
                    GridLayout.autoArrangeImages();
                });
            }

            // Rotation value input
            const rotationValueEl = document.getElementById('rotationValue');
            if (rotationValueEl) {
                rotationValueEl.addEventListener('change', function() {
                    FreeLayout.setRotation(parseInt(this.value) || 0);
                });
            }

            // Navigation
            const prevBtnEl = document.getElementById('prevBtn');
            const nextBtnEl = document.getElementById('nextBtn');
            if (prevBtnEl) prevBtnEl.addEventListener('click', previousPage);
            if (nextBtnEl) nextBtnEl.addEventListener('click', nextPage);

            // Drag and drop on upload area
            setupDragDrop();
        }

        // Setup drag and drop for library upload
        function setupDragDrop() {
            const uploadLabel = document.querySelector('.btn-add');

            if (!uploadLabel) {
                console.log('Upload button not found, skipping drag-drop setup');
                return;
            }

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadLabel.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadLabel.addEventListener(eventName, () => {
                    uploadLabel.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadLabel.addEventListener(eventName, () => {
                    uploadLabel.classList.remove('drag-over');
                }, false);
            });

            uploadLabel.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                PhotoLibrary.uploadPhotos(files);
            }, false);
        }

        // Render current page
        function renderCurrentPage() {
            const page = bookData.pages[currentPageIndex];
            const canvas = document.getElementById('pageCanvas');
            const imageContainer = document.getElementById('imageContainer');
            const textContainer = document.getElementById('textContainer');

            const isFreeMode = page.layoutMode === 'free';

            // Update layout mode toggle
            document.getElementById('layoutModeGrid').checked = !isFreeMode;
            document.getElementById('layoutModeFree').checked = isFreeMode;
            document.getElementById('gridSettings').style.display = isFreeMode ? 'none' : 'block';
            document.getElementById('freeModeSettings').style.display = isFreeMode ? 'block' : 'none';

            // Update canvas
            canvas.className = `page-canvas ${bookData.orientation}`;
            if (isFreeMode) {
                canvas.classList.add('free-layout');
            }
            canvas.style.backgroundColor = page.backgroundColor || '#ffffff';

            // Apply pattern
            canvas.classList.remove('bg-pattern-dots', 'bg-pattern-lines', 'bg-pattern-grid');
            if (page.bgPattern && page.bgPattern !== 'none') {
                canvas.classList.add(`bg-pattern-${page.bgPattern}`);
            }

            // Update image container
            imageContainer.className = `image-grid ${isFreeMode ? 'free' : bookData.layout}`;

            if (!isFreeMode) {
                // Apply grid layout
                const rows = page.gridRows || 2;
                const cols = page.gridCols || 2;
                const spacing = page.gridSpacing || 20;

                imageContainer.style.display = 'grid';
                imageContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                imageContainer.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
                imageContainer.style.gap = `${spacing}px`;
                imageContainer.style.padding = `${page.gridPadding || 40}px`;
            } else {
                imageContainer.style.display = 'block';
                imageContainer.style.padding = '0';
            }

            // Render images
            imageContainer.innerHTML = '';
            page.images.forEach((imageData, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'uploaded-image';
                imgDiv.dataset.index = index;

                if (isFreeMode) {
                    imgDiv.classList.add('free-positioned', 'page-element-image');
                    const imgObj = typeof imageData === 'string' ? {
                        src: imageData,
                        x: 20 + (index % 3) * 250,
                        y: 20 + Math.floor(index / 3) * 250,
                        width: 220,
                        height: 220,
                        rotation: 0,
                        zIndex: index + 1
                    } : imageData;

                    imgDiv.style.left = imgObj.x + 'px';
                    imgDiv.style.top = imgObj.y + 'px';
                    imgDiv.style.width = imgObj.width + 'px';
                    imgDiv.style.height = imgObj.height + 'px';
                    imgDiv.style.zIndex = imgObj.zIndex || index + 1;
                    if (imgObj.rotation) {
                        imgDiv.style.transform = `rotate(${imgObj.rotation}deg)`;
                        imgDiv.setAttribute('data-rotation', imgObj.rotation);
                    }
                    imgDiv.setAttribute('data-x', imgObj.x);
                    imgDiv.setAttribute('data-y', imgObj.y);

                    imgDiv.innerHTML = `
                        <img src="${imgObj.src}" alt="Photo ${index + 1}">
                        <button class="delete-image" onclick="event.stopPropagation(); deleteImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="rotation-handle" title="Drag to rotate">
                            <i class="fas fa-redo"></i>
                        </div>
                    `;
                } else {
                    const src = typeof imageData === 'string' ? imageData : imageData.src;
                    imgDiv.innerHTML = `
                        <img src="${src}" alt="Photo ${index + 1}">
                        <button class="delete-image" onclick="deleteImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                }

                imageContainer.appendChild(imgDiv);
            });

            // Render text blocks
            textContainer.innerHTML = '';
            if (page.textBlocks && page.textBlocks.length > 0) {
                page.textBlocks.forEach((block, index) => {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'page-text-element';
                    textDiv.dataset.index = index;

                    if (isFreeMode) {
                        textDiv.classList.add('free-positioned');
                        textDiv.style.left = (block.x || 20) + 'px';
                        textDiv.style.top = (block.y || 500 + (index * 80)) + 'px';
                        textDiv.style.width = (block.width || 300) + 'px';
                        textDiv.style.zIndex = block.zIndex || 100 + index;
                        if (block.rotation) {
                            textDiv.style.transform = `rotate(${block.rotation}deg)`;
                            textDiv.setAttribute('data-rotation', block.rotation);
                        }
                        textDiv.setAttribute('data-x', block.x || 20);
                        textDiv.setAttribute('data-y', block.y || 500 + (index * 80));

                        textDiv.innerHTML = `
                            ${block.content}
                            <div class="rotation-handle" title="Drag to rotate">
                                <i class="fas fa-redo"></i>
                            </div>
                        `;
                    } else {
                        textDiv.classList.add(`text-position-${block.position || 'bottom'}`);
                        textDiv.textContent = block.content;
                    }

                    // Apply styles
                    textDiv.style.fontFamily = block.fontFamily || "'Montserrat', sans-serif";
                    textDiv.style.fontSize = `${block.fontSize || 16}px`;
                    textDiv.style.fontWeight = block.fontWeight || 400;
                    textDiv.style.color = block.color || '#2c3e50';
                    textDiv.style.textAlign = block.align || 'center';

                    // Apply additional styles
                    if (block.style) {
                        if (block.style.fontStyle) textDiv.style.fontStyle = block.style.fontStyle;
                        if (block.style.textDecoration) textDiv.style.textDecoration = block.style.textDecoration;
                        if (block.style.lineHeight) textDiv.style.lineHeight = block.style.lineHeight;
                        if (block.style.letterSpacing) textDiv.style.letterSpacing = block.style.letterSpacing + 'px';
                        if (block.style.backgroundColor && block.style.backgroundOpacity > 0) {
                            const bgColor = block.style.backgroundColor;
                            const opacity = block.style.backgroundOpacity;
                            // Convert hex to rgba
                            const hex = bgColor.replace('#', '');
                            const r = parseInt(hex.substring(0, 2), 16);
                            const g = parseInt(hex.substring(2, 4), 16);
                            const b = parseInt(hex.substring(4, 6), 16);
                            textDiv.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                        }
                    }

                    textDiv.onclick = (e) => {
                        if (!e.target.classList.contains('rotation-handle')) {
                            TextEditor.selectTextBlock(index);
                            switchToTab('text');
                        }
                    };

                    textContainer.appendChild(textDiv);
                });
            }

            // Update page info (optional elements)
            const currentPageNumberEl = document.getElementById('currentPageNumber');
            const pageIndicatorEl = document.getElementById('pageIndicator');
            const elementCountEl = document.getElementById('elementCount');
            const libraryCountEl = document.getElementById('libraryCount');

            if (currentPageNumberEl) currentPageNumberEl.textContent = currentPageIndex + 1;
            if (pageIndicatorEl) pageIndicatorEl.textContent = currentPageIndex + 1;
            if (elementCountEl) elementCountEl.textContent = (page.images?.length || 0) + (page.textBlocks?.length || 0);
            if (libraryCountEl) libraryCountEl.textContent = bookData.photoLibrary?.length || 0;

            // Update controls (optional elements)
            const bgColorEl = document.getElementById('bgColor');
            const colorValueEl = document.getElementById('colorValue');
            const bgPatternEl = document.getElementById('bgPattern');

            if (bgColorEl) bgColorEl.value = page.backgroundColor || '#ffffff';
            if (colorValueEl) colorValueEl.textContent = page.backgroundColor || '#ffffff';
            if (bgPatternEl) bgPatternEl.value = page.bgPattern || 'none';

            // Update grid controls
            GridLayout.updateControls();

            // Render text blocks list
            TextEditor.renderTextBlocksList();

            // Re-initialize interact.js for new elements
            if (isFreeMode) {
                FreeLayout.reinitialize();
            }
        }

        // Delete image
        function deleteImage(imageIndex) {
            if (!confirm('Delete this image?')) return;

            bookData.pages[currentPageIndex].images.splice(imageIndex, 1);
            saveBookData();
            renderCurrentPage();
            PageManager.renderThumbnailStrip();
            PageManager.showToast('Image deleted');
        }

        // Navigation
        function previousPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                TextEditor.clearSelection();
                FreeLayout.deselectElement();
                saveCurrentPageIndex();
                renderCurrentPage();
                updateNavigationButtons();
                PageManager.updateThumbnailSelection();
            }
        }

        function nextPage() {
            if (currentPageIndex < bookData.numPages - 1) {
                currentPageIndex++;
                TextEditor.clearSelection();
                FreeLayout.deselectElement();
                saveCurrentPageIndex();
                renderCurrentPage();
                updateNavigationButtons();
                PageManager.updateThumbnailSelection();
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) prevBtn.disabled = currentPageIndex === 0;
            if (nextBtn) nextBtn.disabled = currentPageIndex === bookData.numPages - 1;

            // Update page counter in header
            const pageCounter = document.getElementById('pageCounter');
            if (pageCounter) {
                pageCounter.textContent = `Page ${currentPageIndex + 1} / ${bookData.numPages}`;
            }
        }

        // Save functions
        function saveBookData() {
            localStorage.setItem('bookData', JSON.stringify(bookData));
        }

        function saveCurrentPageIndex() {
            localStorage.setItem('currentPageIndex', currentPageIndex.toString());
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loading screen after initialization
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, 800);

            init();

            // Show keyboard hint briefly
            setTimeout(() => {
                const hint = document.getElementById('keyboardHint');
                if (hint) {
                    hint.classList.add('visible');
                    setTimeout(() => hint.classList.remove('visible'), 4000);
                }
            }, 2000);
        });

        // Global keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ignore if typing in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // ? - Show shortcuts help
            if (e.key === '?' || (e.shiftKey && e.key === '/')) {
                e.preventDefault();
                showKeyboardShortcuts();
            }

            // Ctrl/Cmd + S - Save (prevent default, show toast)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveBookData();
                PageManager.showToast('Progress saved');
            }

            // Ctrl/Cmd + E - Export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                PDFExport.showExportDialog();
            }

            // Arrow keys for page navigation (when not editing)
            if (e.key === 'ArrowLeft' && e.altKey) {
                e.preventDefault();
                previousPage();
            }
            if (e.key === 'ArrowRight' && e.altKey) {
                e.preventDefault();
                nextPage();
            }

            // N - New page
            if (e.key === 'n' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                PageManager.addPage();
            }

            // T - Add text
            if (e.key === 't' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                TextEditor.addTextBlock();
                switchToTab('text');
            }

            // G - Toggle grid/free mode
            if (e.key === 'g' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                const page = bookData.pages[currentPageIndex];
                const newMode = page.layoutMode === 'grid' ? 'free' : 'grid';
                document.getElementById(newMode === 'grid' ? 'layoutModeGrid' : 'layoutModeFree').click();
            }

            // 1-9 - Quick page navigation
            if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                const pageNum = parseInt(e.key) - 1;
                if (pageNum < bookData.numPages) {
                    e.preventDefault();
                    PageManager.goToPage(pageNum);
                }
            }
        });

        function showKeyboardShortcuts() {
            let dialog = document.getElementById('shortcutsDialog');
            if (!dialog) {
                dialog = document.createElement('div');
                dialog.id = 'shortcutsDialog';
                dialog.className = 'export-dialog-overlay';
                dialog.innerHTML = `
                    <div class="export-dialog" style="max-width: 500px;">
                        <div class="export-dialog-header">
                            <h4><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h4>
                            <button class="export-dialog-close" onclick="document.getElementById('shortcutsDialog').classList.remove('visible')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="export-dialog-body">
                            <div class="shortcuts-list" style="display: grid; gap: 12px;">
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Save progress</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">Ctrl + S</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Export PDF</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">Ctrl + E</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Previous page</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">Alt + ←</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Next page</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">Alt + →</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Add new page</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">N</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Add text block</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">T</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Toggle Grid/Free mode</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">G</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                                    <span>Go to page 1-9</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">1-9</kbd>
                                </div>
                                <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span>Delete selected element</span>
                                    <kbd style="background: #f0f0f0; padding: 4px 10px; border-radius: 6px; font-size: 12px;">Delete</kbd>
                                </div>
                            </div>
                        </div>
                        <div class="export-dialog-footer">
                            <button class="btn btn-primary" onclick="document.getElementById('shortcutsDialog').classList.remove('visible')">
                                Got it!
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);
                dialog.addEventListener('click', function(e) {
                    if (e.target === dialog) {
                        dialog.classList.remove('visible');
                    }
                });
            }
            dialog.classList.add('visible');
        }
    </script>
</body>
</html>
